#!/bin/bash

set -e

echo "üîç Detecting package manager..."

if command -v dnf >/dev/null 2>&1; then
    # Rocky Linux, Fedora, RHEL (dnf)
    echo "üì¶ Installing Visual Studio Code (dnf-based system)..."

    # Import Microsoft GPG key
    sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc

    # Add VSCode repo
    sudo tee /etc/yum.repos.d/vscode.repo > /dev/null << EOF
[code]
name=Visual Studio Code
baseurl=https://packages.microsoft.com/yumrepos/vscode
enabled=1
gpgcheck=1
gpgkey=https://packages.microsoft.com/keys/microsoft.asc
EOF

    echo "üîÑ Updating system..."
    sudo dnf upgrade -y  # Automatically agree to upgrades
    sudo dnf install -y code git

elif command -v apt >/dev/null 2>&1; then
    # Ubuntu, Debian (apt)
    echo "üì¶ Installing Visual Studio Code (apt-based system)..."

    # Install dependencies
    sudo apt update
    sudo apt install -y wget gpg

    # Download and install the GPG key
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/microsoft.gpg > /dev/null

    # Add VSCode repo
    echo "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main" | sudo tee /etc/apt/sources.list.d/vscode.list > /dev/null

    # Update repositories and install
    sudo apt update
    sudo apt install -y code git

    # Clean up
    rm -f microsoft.gpg

else
    echo "‚ùå Neither dnf nor apt found. Unsupported system."
    exit 1
fi

# Git configuration (optional)
echo "üîß Configuring Git user settings..."
git config --global user.name "Ricardo Gonzalez"
git config --global user.email "ricardo@linux.local"
git config --global push.autoSetupRemote true

# Confirm installation
if command -v code > /dev/null 2>&1; then
    echo "‚úÖ Visual Studio Code has been successfully installed."
else
    echo "‚ùå There was an error installing Visual Studio Code."
    exit 1
fi
